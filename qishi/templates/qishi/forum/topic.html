{% extends "qishi/base.html" %}

{% load qishi_filters %}

{% block body %}

<div class="container" style="margin-top: 70px">

    <div class="row">
        <p><a href="{% url 'qishi.views_forum.display_forum' forum_id=topic.forum.id %}">Back to {{topic.forum}}</a></p>
    </div>

    <div class="row">

        <div class="thumbnail">
            <table class="table table-striped">
                
                <thead>
                    <tr>
                        <th colspan="3"><span class="glyphicon glyphicon-bookmark"></span> {{topic.subject}}</th>
                    </tr>
                </thead>

                <tbody>
                    <!-- Allow Staff to push a post to the blog -->
                    {% if user.is_staff %}
                        <tr>
                            <td>
                                <a href="{% url 'qishi.views_forum.update_topic_attr_switch' topic_id=topic.id attr='is_blog' %}">
                                {% if topic.is_blog %} unset blog {% else %} set blog {% endif %}
                                </a>  
                            <td>
                        </tr>
                    {% endif %}

                    <tr>
                        <td>Opened by <a href="{% url 'accounts.views.profile' user_id=topic.posted_by.pk %}">{{ topic.posted_by }}</a> </td>
                        <td>{{ topic.num_likes }} likes  </td>
                        <td>{{ topic.num_views }} views  </td>
                        {% if user.is_staff %}
                            <td><a href="{% url 'qishi.views_forum.delete_topic' topic_id=topic.id %}" onclick="return confirm('Do you want to delete it?')">Delete the topic</a></td>
                        {% endif %}
                    </tr>
                
                    {% for post in posts %}
                    <tr>
                        <td>Posted by <a href="{% url 'accounts.views.profile' user_id=post.posted_by.pk %}">{{ post.posted_by }}</a> </td>
                        <td>  {{ post.created_on }} </td>
                        {% if user.is_staff or user.id == post.posted_by.id %}
                            <td><a href="{% url 'qishi.views_forum.delete_post' post_id=post.id %}" onclick="return confirm('Do you want to delete it?')">Delete</a></td>
                        {% endif %}
                        
                        {% if user.id == post.posted_by.id %}
                            <td><a href="{% url 'qishi.views_forum.edit_post' post_id=post.id %}"  >Edit</a></td>
                        {% endif %}
                        
                    </tr>
                        <tr>
                            <td colspan="3">{{ post.message|text_markdown|safe }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if user.is_authenticated %}
        <div class="thumbnail">
            <h2><span> Quick reply to this topic </span></h2>
            <form action="{% url 'qishi.views_forum.new_reply' topic_id=topic.id %}"  method="post" >
                {% csrf_token %} 
                   <div class="form-group">
                   {{ form.message }}
                   </div>
                   <input type="submit" value="Submit">
            </form>         
            {% endif %}
        </div>
        
    </div>

</div>

{% endblock %}